<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Backend developer guide - The Diplomat Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Diplomat Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="how-to-set-up-a-minimal-backend"><a class="header" href="#how-to-set-up-a-minimal-backend">How to Set up a Minimal Backend</a></h1>
<p>How to create a backend is quite language dependent, and what is easier in one
may be harder in another. Below we will start setting up a simple backend. We'll
show you how to set up a test in diplomat so you can start generating code quickly.
Then we give you a template for a simple dynamic library that you can then link
to your host language. Finally we provide a suggested checklist for your backend.
It is not automatically generated so when in doubt look at diplomat's <a href="https://docs.rs/diplomat_core/latest/diplomat_core/hir/index.html">HIR</a></p>
<ul>
<li><input disabled="" type="checkbox"/>
<strong>project structure</strong>: You will need need to test your generated code so you should
first set up a host language project. It should have all dependencies to be able to interface
with native code (or WASM).</li>
</ul>
<h2 id="setting-up-basic-code-generation-in-a-test"><a class="header" href="#setting-up-basic-code-generation-in-a-test">Setting up Basic Code Generation in a Test</a></h2>
<p>Your backend should iterate over all <a href="https://docs.rs/diplomat_core/latest/diplomat_core/hir/enum.TypeDef.html"><code>TypeDefs</code></a>
and generate the required code for these. To do that we start with an
<a href="https://docs.rs/diplomat_core/latest/diplomat_core/ast/struct.File.html"><code>ast::File</code></a>, which can
then be parsed into a <a href="https://docs.rs/diplomat_core/latest/diplomat_core/struct.Env.html"><code>Env</code></a>
using the
<a href="https://docs.rs/diplomat_core/latest/diplomat_core/ast/struct.File.html#method.all_types"><code>all_types</code></a>
method. Then we can create the
<a href="https://docs.rs/diplomat_core/latest/diplomat_core/hir/struct.TypeContext.html"><code>TypeContext</code></a>
which is generated using the
<a href="https://docs.rs/diplomat_core/latest/diplomat_core/hir/struct.TypeContext.html#method.from_ast"><code>from_ast</code></a>
method. You will also need an
<a href="https://docs.rs/diplomat_core/latest/diplomat_core/hir/trait.AttributeValidator.html"><code>AttributeValidator</code></a>,
but should probably start with the simple
<a href="https://docs.rs/diplomat_core/latest/diplomat_core/hir/struct.BasicAttributeValidator.html"><code>BasicAttributeValidator</code></a>.</p>
<p>We will now build an example by way of a test. A good starting point is to create a test for
generating a simple opaque struct without any methods. Your backend should go in the tool crate:
create a module <code>tool/src/{backend}/mod.rs</code>  (make sure you add a line <code>pub mod backend;</code> to
<code>tool/src/lib.rs</code>). Add the following to it</p>
<pre><code class="language-rs">use diplomat_core::hir::{OpaqueDef, TypeContext, TypeId};

fn gen_opaque_def(ctx: &amp;TypeContext, type_id: TypeId, opaque_path: &amp;OpaqueDef) -&gt; String {
    "We'll get to it".into()
}

#[cfg(test)]
mod test {
    use diplomat_core::{
        ast::{self},
        hir::{self, TypeDef},
    };
    use quote::quote;

    #[test]
    fn test_opaque_gen() {
        let tokens = quote! {
            #[diplomat::bridge]
            mod ffi {

                #[diplomat::opaque]
                struct OpaqueStruct;

            }
        };
        let item = syn::parse2::&lt;syn::File&gt;(tokens).expect("failed to parse item ");

        let diplomat_file = ast::File::from(&amp;item);
        let env = diplomat_file.all_types();
        let attr_validator = hir::BasicAttributeValidator::new("my_backend_test");

        let context = match hir::TypeContext::from_ast(&amp;env, attr_validator) {
            Ok(context) =&gt; context,
            Err(e) =&gt; {
                for (_cx, err) in e {
                    eprintln!("Lowering error: {}", err);
                }
                panic!("Failed to create context")
            }
        };

        let (type_id, opaque_def) = match context
            .all_types()
            .next()
            .expect("Failed to generate first opaque def")
        {
            (type_id, TypeDef::Opaque(opaque_def)) =&gt; (type_id, opaque_def),
            _ =&gt; panic!("Failed to find opaque type from AST"),
        };

        let generated = super::gen_opaque_def(&amp;context, type_id, opaque_def);

        insta::assert_snapshot!(generated)
    }
}
</code></pre>
<p>You can now run</p>
<pre><code class="language-sh">cargo test -p diplomat-tool -- backend::test --nocapture
</code></pre>
<p>You should also have a generated snapshot <code>diplomat_tool__backend__test__opaque_gen.snap.new</code>
which you can use to pick up your generated code.</p>
<h2 id="how-to-generate-the-library"><a class="header" href="#how-to-generate-the-library">How to Generate the Library</a></h2>
<p>Now to actually test native methods you will need to create some kind of library, be it static, dynamic, or
even WASM. In the following we will be creating a dynamically linked library.</p>
<p>You should set up a separate rust project next to your diplomat fork e.g. <code>mybackendtest</code></p>
<pre><code class="language-sh">cargo new --lib mybackendtest
</code></pre>
<p>with the following Cargo.toml</p>
<pre><code class="language-toml">[package]
name = "mybackendtest"
version = "0.1.0"
edition = "2021"

[lib]
crate_type = ["cdylib"]
name = "mybackendtest"

[dependencies]
diplomat = {path = "../diplomat/macro"}
diplomat-runtime = {path = "../diplomat/runtime"}
</code></pre>
<p>Because you are using path dependencies, it is important that your library project be in
the same directory as your fork of diplomat</p>
<p>Copy the following into your lib.rs</p>
<pre><code class="language-rs">#[diplomat::bridge]
mod ffi {

    #[diplomat::opaque]
    struct OpaqueStruct;

    impl OpaqueStruct {
        pub fn add_two(i: i32) -&gt; i32 {
            i + 2
        }
    }
}

</code></pre>
<p>Note it is very important that the method be marked <code>pub</code> otherwise diplomat will ignore it.
Now you can run</p>
<pre><code class="language-sh">cargo build
</code></pre>
<p>to create a debug artifact in <code>target/debug/libmybackendtest.dylib</code></p>
<h2 id="getting-access-to-your-native-method"><a class="header" href="#getting-access-to-your-native-method">Getting Access to your Native Method</a></h2>
<p>Now we can add code that will iterate over all of the methods of the opaque struct.
First, copy the impl block for <code>OpaqueStruct</code> into the test code underneath the <code>OpaqueStruct</code>.
Next, update your the code for <code>gen_opaque_def</code> to the following which will generate the native
symbol for your new impl method:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use crate::c2::CFormatter;

fn gen_opaque_def(ctx: &amp;TypeContext, type_id: TypeId, opaque_path: &amp;OpaqueDef) -&gt; String {
    let c_formatter = CFormatter::new(ctx);

    opaque_def
        .methods
        .iter()
        .map(|method| c_formatter.fmt_method_name(type_id, method))
        .collect::&lt;Vec&lt;_&gt;&gt;()
        .join("\n")
}
<span class="boring">}</span></code></pre></pre>
<p>Now your snapshot should have the following contents</p>
<pre><code>---
source: tool/src/backend/mod.rs
assertion_line: 67
expression: generated
---
OpaqueStruct_add_two
</code></pre>
<p>where <code>OpaqueStruct_add_two</code> is the native symbol for your method. It has a simple signature <code>i32 -&gt; i32</code>,
so now you have a dynamic library and a symbol to load from it that you can start building. Now it is up
to you to figure how to integrate these into your host language project skeleton.</p>
<h2 id="minimal-backend"><a class="header" href="#minimal-backend">Minimal Backend</a></h2>
<p>You should now work on building a minimal backend that can generate opaque type definitions
with methods that only accept and return <a href="https://docs.rs/diplomat_core/latest/diplomat_core/hir/enum.PrimitiveType.html"><strong>primitive types</strong></a>.</p>
<p>You will need to update <code>tool/src/lib.rs</code> to add handling for your backend.</p>
<p>Once you have the basics of a backend you can add attribute handling. The best way to do this is to check the existing backends
e.g. <a href="https://github.com/rust-diplomat/diplomat/blob/b3a8702f6736dbd6e667638ca0025b8f8cd1509f/tool/src/lib.rs#L95">dart</a>(Note: git permalink may be out of date).
The most important is to ignore disabled types and methods, as then you can take advantage of diplomat's feature tests
and start building progressively.</p>
<h2 id="feature-tests"><a class="header" href="#feature-tests">Feature Tests</a></h2>
<p>Diplomat already includes feature tests that you can disable with <code>#[diplomat::attrs(disable, {backend})]</code>.
where <code>{backend}</code> refers to your new backend. As you add functionality to your backend you
can progressively enable the types and methods for your backend. This way you can iterate with
working examples. These are called via <a href="https://sagiegurari.github.io/cargo-make/">cargo-make</a>
e.g</p>
<pre><code class="language-sh">cargo make gen-dart-feature
</code></pre>
<p>You can look at <code>Makefile.toml</code> to see how tasks are defined. Most of the generative tasks make use of this
<a href="https://github.com/rust-diplomat/diplomat/blob/b3a8702f6736dbd6e667638ca0025b8f8cd1509f/support/functions.ds#L1">duckscript function</a>
(<a href="https://sagiegurari.github.io/duckscript/">Duckscript</a> is a simple scripting language)</p>
<h2 id="backend-checklist"><a class="header" href="#backend-checklist">Backend Checklist</a></h2>
<ul>
<li><input disabled="" type="checkbox"/>
<a href="https://docs.rs/diplomat_core/latest/diplomat_core/hir/enum.PrimitiveType.html"><strong>primitive types</strong></a>: This will be the most basic piece of the backend, and you will want
to implement them early in order to test your ability to correctly call methods.</li>
<li><input disabled="" type="checkbox"/>
<a href=""><strong>opaque types</strong></a>:
<ul>
<li><input disabled="" type="checkbox"/>
basic definiton</li>
<li><input disabled="" type="checkbox"/>
return a boxed opaque. This needs to be cleaned in managed languages.
You can use the autogenerated <code>{OpaqueName}_destroy({OpaqueName}*)</code> native method to clean up
the memory of the associated opaque.</li>
<li><input disabled="" type="checkbox"/>
as self parameter</li>
<li><input disabled="" type="checkbox"/>
as another parameter</li>
</ul>
</li>
<li><input disabled="" type="checkbox"/>
<a href="https://docs.rs/diplomat_core/0.7.0/diplomat_core/hir/struct.StructDef.html"><strong>structs</strong></a></li>
<li><input disabled="" type="checkbox"/>
<a href="https://docs.rs/diplomat_core/0.7.0/diplomat_core/hir/struct.EnumDef.html"><strong>enums</strong></a></li>
<li><input disabled="" type="checkbox"/>
<a href="https://docs.rs/diplomat_core/0.7.0/diplomat_core/hir/enum.SuccessType.html#variant.Writeable"><strong>writeable</strong></a></li>
<li><input disabled="" type="checkbox"/>
<a href="https://docs.rs/diplomat_core/0.7.0/diplomat_core/hir/enum.Slice.html"><strong>slices</strong></a>
<ul>
<li><input disabled="" type="checkbox"/>
primitive slices</li>
<li><input disabled="" type="checkbox"/>
str slices</li>
<li><input disabled="" type="checkbox"/>
owned slices</li>
<li><input disabled="" type="checkbox"/>
slices of strings</li>
<li><input disabled="" type="checkbox"/>
strings</li>
</ul>
</li>
<li><input disabled="" type="checkbox"/>
borrows. This is probably one of the trickiest things, as you need to ensure that managed objects don't get
cleaned up if something depends on them.
<ul>
<li><input disabled="" type="checkbox"/>
borrows of parameters</li>
<li><input disabled="" type="checkbox"/>
in struct fields</li>
</ul>
</li>
<li><input disabled="" type="checkbox"/>
nullables, i.e. returning option types.</li>
<li><input disabled="" type="checkbox"/>
fallibles, i.e. returning result types. The resulting native type will be a discriminated union.</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="safety.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="demo_gen/intro.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="safety.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="demo_gen/intro.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
