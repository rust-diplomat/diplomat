final class _{{type_name}}Ffi extends ffi.Struct {
  {%- for field in fields %}
  {%- match field.annotation %}
  {%- when Some with (annotation) %}
  @{{annotation}}()
  {%- when None %}
  {%- endmatch %}
  external {{field.ffi_cast_type_name}} {{field.name}};
  {%- endfor %}
}

{% if !docs.is_empty() -%}
/// {{docs}}
{% endif -%}
final class {{type_name}} {

  {%- for field in fields %}
  {% if !mutable -%} final {% endif -%} {{field.dart_type_name}} {{field.name}};
  {%- endfor %}

  {%- match default_constructor %}
  {%- when Some with (c) %}

  {{c}}
  {%- when None %}
  {%- endmatch %}

  // ignore: unused_element
  // Internal constructor from FFI.
  {%- if lifetimes.all_lifetimes().len() == 0 %}
  // This struct contains borrowed fields, so this takes in a list of
  // "edges" corresponding to where each lifetime's data may have been borrowed from
  // and passes it down to individual fields containing the borrow.
  // This method does not attempt to handle any dependencies between lifetimes, the caller
  // should handle this when constructing edge arrays.
  {%- endif %}
  {{type_name}}._(_{{type_name}}Ffi underlying {%- for lifetime in lifetimes.all_lifetimes() -%} , core.List<Object> edge_{{lifetimes.fmt_lifetime(lifetime)}} {%- endfor -%}) :
    {%- for field in fields %}
    {{field.name}} = {{field.c_to_dart}}
    {%- if loop.last %};{% else %},{% endif -%}
    {%- endfor %}

  // ignore: unused_element
  _{{type_name}}Ffi _pointer(ffi.Allocator temp) {
    final pointer = temp<_{{type_name}}Ffi>();
    {%- for field in fields %}
    {%- for statement in field.dart_to_c %}
    {{statement}}
    {%- endfor %}
    {%- endfor %}
    return pointer.ref;
  }

  {%- for m in methods %}
{% include "method.dart.jinja" %}
  {%- endfor %}

  @override
  bool operator ==(Object other) =>
      other is {{type_name}}
      {%- for field in fields %} &&
      other.{{field.name}} == this.{{field.name}}
      {%- endfor %};

  @override
  int get hashCode => Object.hashAll([
      {%- for field in fields %}
        this.{{field.name}},
      {%- endfor %}
      ]);


  {%- for l in lifetimes.all_lifetimes() %}
    {%- let ltname = lifetimes.fmt_lifetime(l) %}
    {%- let longer = self::iterator_to_btreeset(lifetimes.all_longer_lifetimes(l)) %}

  // ignore: unused element
  // Append all fields corresponding to lifetime `'{{ltname}}` 
  {%- if longer.len() > 1 %}
  // and lifetimes longer than it (Lifetimes: {{self::display_lifetime_list(lifetimes, longer)}})
  // This is all fields that may be borrowed from if borrowing `'{{ltname}}`
  {%- endif %}
  core.List<Object> _fields_for_lifetime_{{ltname}}() {
    return [
    {%- for field in self::iter_fields_with_lifetimes_from_set(fields, longer) %}
        {%- if !loop.first %}, {% endif -%}
        {{field.name}}
    {%- endfor -%}
    ];
  }

  {%- endfor %}
}

{%- for m in methods %}

{% include "native_method.dart.jinja" %}
{%- endfor %}
